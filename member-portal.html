<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>会员积分 · 结果</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="supabase.js"></script>
</head>
<body>
  <!-- 顶栏 -->
  <div class="navbar">
    <div class="navbar-inner container">
      <div class="brand"><span class="crest"></span><span data-i18n="result_title">查询结果</span></div>
      <div class="actions">
        <a class="btn" href="index.html" data-i18n="back_home">返回首页</a>
        <a class="btn" href="login.html" data-i18n="btn_admin">后台</a>
        <div class="lang-pill">
          <select class="lang">
            <option value="zh">中</option>
            <option value="en">EN</option>
            <option value="ms">BM</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- 结果卡 -->
  <div class="container">
    <div class="card" style="max-width:920px;margin:18px auto">
      <h2 style="margin:0 0 10px" data-i18n="result_title">查询结果</h2>

      <div id="bio" class="sub" style="margin:0 0 10px">—</div>

      <div class="kpi" style="margin:6px 0 16px">
        <div class="value" id="tp">0</div>
        <div class="hint" data-i18n="result_total">总积分</div>
      </div>

      <h3 style="margin:16px 0 8px" data-i18n="history_title">积分记录</h3>
      <table class="table">
        <thead>
          <tr>
            <th data-i18n="th_points">积分</th>
            <th data-i18n="th_note">备注</th>
            <th data-i18n="th_time">时间</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>

  <!-- 语言脚本 -->
  <script src="lang.js"></script>

  <script type="module">
    import { supabase } from './supabase.js'

    const bio = document.getElementById('bio')
    const tp = document.getElementById('tp')
    const tb = document.getElementById('tb')

    const langGet = k => {
      const L = (window.I18N && I18N[localStorage.getItem('lang')||'zh']) || {}
      return L[k] || ''
    }

    const phone = new URLSearchParams(location.search).get('phone')
    if(!phone){ bio.textContent = langGet('not_found') || '未找到该会员'; fillTable([]); throw new Error('no phone') }

    // 1) 姓名/电话/总分
    const { data: mp, error: e1 } = await supabase
      .from('member_points')
      .select('name,phone,total_points')
      .eq('phone', phone)
      .maybeSingle()
    if(e1 || !mp){
      bio.textContent = langGet('not_found') || '未找到该会员'
      tp.textContent = '—'
    }else{
      bio.textContent = `姓名：${mp.name}（${mp.phone}）`
      tp.textContent = mp.total_points
    }

    // 2) 历史记录（最近 30）
    const { data: rows, error: e2 } = await supabase
      .from('point_transactions')
      .select('points,note,created_at,members!inner(phone)')
      .eq('members.phone', phone)
      .order('created_at',{ascending:false})
      .limit(30)

    if(e2){ fillTable([], e2.message) } else { fillTable(rows||[]) }

    function fillTable(rows, err){
      if(err){ tb.innerHTML = `<tr><td colspan="3" style="color:#c00">${langGet('fetch_fail')||'查询失败，请稍后重试'}</td></tr>`; return }
      if(!rows.length){ tb.innerHTML = `<tr><td colspan="3">${langGet('no_rows')||'暂无记录'}</td></tr>`; return }
      tb.innerHTML = rows.map(r =>
        `<tr><td>${r.points}</td><td>${r.note||''}</td><td>${new Date(r.created_at).toLocaleString()}</td></tr>`
      ).join('')
    }
  </script>
</body>
</html>
