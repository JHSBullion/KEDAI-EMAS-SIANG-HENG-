<!doctype html><html lang="zh"><head>
<meta charset="utf-8"><title data-i18n="member_portal">会员入口</title>
<link rel="stylesheet" href="style.css"><script src="lang.js"></script>
<script type="module" src="supabase.js"></script>
</head><body>
<header><h1 data-i18n="member_portal">会员入口</h1>
  <nav class="right">
    <a href="#" onclick="setLang('zh')">中</a>
    <a href="#" onclick="setLang('en')">EN</a>
    <a href="#" onclick="setLang('ms')">BM</a>
  </nav>
</header>
<main>
  <div class="card">
    <label data-i18n="enter_phone">输入你的电话号码</label>
    <form id="f"><input id="ph" required placeholder="0123456789">
      <button type="submit" data-i18n="check_points">查询积分</button></form>
    <div id="msg" class="msg"></div>
  </div>
  <div id="panel" class="card" style="display:none">
    <h2 data-i18n="your_points">当前积分</h2>
    <p><b data-i18n="name">姓名</b>：<span id="nm"></span></p>
    <p><b data-i18n="phone">电话</b>：<span id="pp"></span></p>
    <p><b data-i18n="total_points">总积分</b>：<span id="tp" style="font-size:28px"></span></p>
    <h3 data-i18n="history">积分记录</h3>
    <table><thead><tr><th data-i18n="points">积分</th><th data-i18n="note">备注</th><th data-i18n="created_at">时间</th></tr></thead><tbody id="tb"></tbody></table>
    <p class="small">* 如果手机号输错或未注册，请联系店员协助。</p>
  </div>
</main>
<script type="module">
  import { supabase } from './supabase.js'
  const f=document.getElementById('f'), msg=document.getElementById('msg'), panel=document.getElementById('panel')
  const nm=document.getElementById('nm'), pp=document.getElementById('pp'), tp=document.getElementById('tp'), tb=document.getElementById('tb')
  f.addEventListener('submit', async (e)=>{ e.preventDefault(); msg.textContent=''; panel.style.display='none'
    const phone=document.getElementById('ph').value.trim()
    const { data: mp, error } = await supabase.from('member_points').select('*').eq('phone', phone).single()
    if(error||!mp){ msg.className='msg err'; msg.textContent=document.querySelector('[data-i18n="no_member"]').textContent || '没有找到该会员'; return }
    nm.textContent = mp.name; pp.textContent = mp.phone; tp.textContent = mp.total_points;
    const { data: hist } = await supabase.from('point_transactions').select('points,note,created_at,members!inner(phone)').eq('members.phone', phone).order('created_at',{ascending:false}).limit(20)
    tb.innerHTML = (hist||[]).map(r=>`<tr><td>${r.points}</td><td>${r.note||''}</td><td>${new Date(r.created_at).toLocaleString()}</td></tr>`).join('') || '<tr><td colspan="3">-</td></tr>'
    panel.style.display='block'
  })
</script>
</body></html>