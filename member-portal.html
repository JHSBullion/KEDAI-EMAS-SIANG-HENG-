<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Portal</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="supabase.js"></script>
  <script defer src="lang.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <span class="logo">●</span>
      <span class="brand-line">KEDAI EMAS SIANG HENG</span>
      <span class="muted"> · </span>
      <span class="brand-sub" data-i18n="portal">Member Portal</span>
    </div>
    <nav class="nav">
      <a class="pill" href="index.html" data-i18n="home">Home</a>
      <select id="langSwitch" class="lang-switch">
        <option value="zh">中</option>
        <option value="en">EN</option>
        <option value="ms">BM</option>
      </select>
    </nav>
  </header>
  <main class="container">
    <section class="card">
      <h2 data-i18n="results">Member Information</h2>
      <div id="memberBox" class="member-box"></div>
      <h3 class="mt" data-i18n="history">Point History</h3>
      <div id="historyBox" class="history"></div>
    </section>
  </main>
  <footer class="site-footer">© 2025 KEDAI EMAS SIANG HENG</footer>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const phone = new URLSearchParams(location.search).get("phone");
  if(!phone){ document.getElementById("memberBox").innerHTML = `<p class="danger" data-i18n="need_phone">Please provide phone.</p>`; applyTranslations(); return; }
  const {{ data: members, error }} = await sb.from('members').select('id,name,phone,created_at').eq('phone', phone).limit(1);
  if(error){ document.getElementById('memberBox').innerHTML = `<p class="danger">${error.message}</p>`; return; }
  if(!members || members.length===0){ document.getElementById('memberBox').innerHTML = `<p class="danger" data-i18n="not_found">Member not found.</p>`; applyTranslations(); return; }
  const m = members[0];
  // total points
  const {{ data: rows, error: e2 }} = await sb.rpc('sum_points_by_member', {{ mid: m.id }}).maybeSingle();
  // Fallback if no RPC: sum locally
  let total = 0;
  if(rows && typeof rows.total === 'number') total = rows.total;
  else { 
    const {{ data: tlist }} = await sb.from('point_transactions').select('delta').eq('member_id', m.id);
    total = (tlist||[]).reduce((a,b)=>a+(b.delta||0),0);
  }
  document.getElementById('memberBox').innerHTML = `
    <div class="grid2">
      <div><div class="label" data-i18n="name">Name</div><div class="value">${m.name||'-'}</div></div>
      <div><div class="label" data-i18n="phone">Phone</div><div class="value">${m.phone}</div></div>
    </div>
    <div class="points-big">${total}</div>
  `;
  const {{ data: hist }} = await sb.from('point_transactions').select('delta,note,created_at').eq('member_id', m.id).order('created_at',{ascending:false}).limit(50);
  const box = document.getElementById('historyBox');
  if(!hist || hist.length===0) box.innerHTML = `<div class="muted" data-i18n="no_records">No records</div>`;
  else box.innerHTML = hist.map(r => `
    <div class="row">
      <div class="delta ${r.delta>=0?'pos':'neg'}">${r.delta>=0?'+':''}${r.delta}</div>
      <div class="note">${r.note||''}</div>
      <div class="time">${new Date(r.created_at).toLocaleString()}</div>
    </div>
  `).join('');
  applyTranslations();
});
</script>
</body>
</html>
