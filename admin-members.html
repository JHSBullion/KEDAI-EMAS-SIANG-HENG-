<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title data-i18n="members">会员管理</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="supabase.js"></script>
  <script src="lang.js"></script>
</head>
<body>
<header>
  <h1 data-i18n="members">会员管理</h1>
  <button onclick="logout()" data-i18n="btn_logout">登出</button>
</header>
<main>
  <div class="card">
    <h2 data-i18n="add_member">新增会员</h2>
    <form id="addForm">
      <label data-i18n="name">姓名</label>
      <input id="name" required>
      <label data-i18n="phone">电话</label>
      <input id="phone" required>
      <button type="submit" data-i18n="btn_add">添加</button>
    </form>
    <div id="msg"></div>
  </div>
  <div class="card">
    <h2 data-i18n="members_list">会员列表</h2>
    <input id="search" placeholder="搜索...">
    <table>
      <thead><tr><th data-i18n="name">姓名</th><th data-i18n="phone">电话</th><th data-i18n="created_at">创建时间</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>
<script type="module">
  import { supabase, logout } from './supabase.js'
  const form = document.getElementById('addForm')
  const msg = document.getElementById('msg')
  const tbody = document.getElementById('tbody')
  const search = document.getElementById('search')
  form.addEventListener('submit', async (e)=>{
    e.preventDefault()
    const name = document.getElementById('name').value.trim()
    const phone = document.getElementById('phone').value.trim()
    const { data, error } = await supabase.from('members').insert([{ name, phone }]).select()
    if(error){ msg.textContent = error.message; return }
    msg.textContent = "添加成功"
    form.reset()
    loadMembers()
  })
  async function loadMembers(){
    const q = search.value.trim()
    let query = supabase.from('members').select('*').order('created_at',{ascending:false})
    if(q) query = supabase.from('members').select('*').or(`name.ilike.%${q}%,phone.ilike.%${q}%`)
    const { data, error } = await query
    tbody.innerHTML = (data||[]).map(m=>`<tr><td>${m.name}</td><td>${m.phone}</td><td>${m.created_at}</td></tr>`).join("")
  }
  search.addEventListener('input', loadMembers)
  loadMembers()
</script>
</body>
</html>