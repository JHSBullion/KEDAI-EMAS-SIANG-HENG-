
<!doctype html><html lang="zh">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · Members</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="lang.js"></script>
  <script src="app.js"></script>
  <script src="supabase.js"></script>
</head>
<body>
  <div id="nav"></div>
  <div class="container">
    <div class="grid two">
      <div class="card">
        <div class="title" data-i18n="addMember">新增会员</div>
        <label data-i18n="name">姓名</label>
        <input id="mname" class="input" data-ph="name">
        <label data-i18n="phone">电话</label>
        <input id="mphone" class="input mono" data-ph="phone">
        <div class="actions">
          <button class="btn gold" onclick="addMember()" data-i18n="submit">提交</button>
          <div id="mmsg" class="note hidden"></div>
        </div>
      </div>
      <div class="card">
        <div class="title" data-i18n="members">会员管理</div>
        <div class="search">
          <input id="q" class="input" style="max-width:300px" data-ph="searchHint" placeholder="Search name or phone…">
          <button class="btn" onclick="loadMembers()" data-i18n="members">会员</button>
        </div>
        <table class="table" id="mtable">
          <thead><tr>
            <th data-i18n="name">姓名</th><th data-i18n="phone">电话</th><th data-i18n="createdAt">创建时间</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>

<script>
document.getElementById('nav').innerHTML = adminbar('members');
bindLangSelect();
guard();

async function addMember(){
  const name = document.getElementById('mname').value.trim();
  const phone = document.getElementById('mphone').value.trim();
  const msg = document.getElementById('mmsg');
  msg.classList.add('hidden'); msg.textContent='';
  if(!name || !phone){ msg.textContent='Name/Phone required'; msg.classList.remove('hidden'); return; }
  try{
    const { data, error } = await sb.from('members').insert({ name, phone });
    if(error){ msg.textContent=error.message; msg.classList.remove('hidden'); return; }
    document.getElementById('mname').value=''; document.getElementById('mphone').value='';
    loadMembers();
  }catch(e){ msg.textContent=e.message; msg.classList.remove('hidden'); }
}

async function loadMembers(){
  const q = document.getElementById('q').value.trim();
  let query = sb.from('members').select('*').order('created_at', { ascending:false }).limit(200);
  if(q){ query = query.ilike('name', `%${q}%`).or(`phone.ilike.%${q}%`); }
  const { data, error } = await query;
  const tb = document.querySelector('#mtable tbody'); tb.innerHTML='';
  if(error){ tb.innerHTML = `<tr><td colspan="3" class="bad">${error.message}</td></tr>`; return; }
  (data||[]).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name||''}</td><td class="mono">${r.phone||''}</td><td>${r.created_at||''}</td>`;
    tb.appendChild(tr);
  });
}
loadMembers();
</script>
</body></html>
