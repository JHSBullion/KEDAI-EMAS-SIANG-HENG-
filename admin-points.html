<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title data-i18n="points">积分管理</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="supabase.js"></script>
  <script src="lang.js"></script>
</head>
<body>
<header>
  <h1 data-i18n="points">积分管理</h1>
  <button onclick="logout()" data-i18n="btn_logout">登出</button>
</header>
<main>
  <div class="card">
    <h2 data-i18n="adjust_points">调整积分</h2>
    <form id="pointsForm">
      <label data-i18n="phone">电话</label>
      <input id="phone" required>
      <label data-i18n="points">积分</label>
      <input id="points" type="number" required>
      <label data-i18n="note">备注</label>
      <input id="note">
      <button type="submit" data-i18n="btn_submit">提交</button>
    </form>
    <div id="msg"></div>
  </div>
  <div class="card">
    <h2 data-i18n="recent_points">最近积分记录</h2>
    <table>
      <thead><tr><th data-i18n="phone">电话</th><th data-i18n="points">积分</th><th data-i18n="note">备注</th><th data-i18n="created_at">时间</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>
<script type="module">
  import { supabase, logout } from './supabase.js'
  const form = document.getElementById('pointsForm')
  const msg = document.getElementById('msg')
  const tbody = document.getElementById('tbody')
  form.addEventListener('submit', async (e)=>{
    e.preventDefault()
    const phone = document.getElementById('phone').value.trim()
    const points = parseInt(document.getElementById('points').value)
    const note = document.getElementById('note').value
    const { data: members } = await supabase.from('members').select('id').eq('phone', phone).single()
    if(!members){ msg.textContent = "会员不存在"; return }
    const { error } = await supabase.from('point_transactions').insert([{ member_id: members.id, points, note }])
    if(error){ msg.textContent = error.message; return }
    msg.textContent = "积分已更新"
    form.reset()
    loadPoints()
  })
  async function loadPoints(){
    const { data, error } = await supabase.from('point_transactions').select('*, members(phone)').order('created_at',{ascending:false}).limit(20)
    tbody.innerHTML = (data||[]).map(r=>`<tr><td>${r.members?.phone||''}</td><td>${r.points}</td><td>${r.note||''}</td><td>${r.created_at}</td></tr>`).join("")
  }
  loadPoints()
</script>
</body>
</html>