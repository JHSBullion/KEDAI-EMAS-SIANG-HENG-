<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>后台 · 积分管理</title>
  <link rel="stylesheet" href="style.css">
  <script src="lang.js" defer></script>
  <script type="module" src="supabase.js"></script>
</head>
<body>
  <div class="navbar">
    <div class="navbar-inner container">
      <div class="brand"><span class="crest"></span><span>后台 · 积分管理</span></div>
      <div class="actions">
        <a class="btn" href="admin-members.html">会员管理</a>
        <a class="btn" href="admin-points.html">积分管理</a>
        <a class="btn" href="index.html">首页</a>
        <select class="lang"><option value="zh">中</option><option value="en">EN</option><option value="ms">BM</option></select>
        <button id="logout" class="btn btn-gold">登出</button>
      </div>
    </div>
  </div>

  <div class="container" style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <div class="card">
      <h2>调整积分</h2>
      <form id="f">
        <label>电话</label><input id="ph" class="input" required>
        <label>积分（正数加分，负数扣分）</label><input id="pts" class="input" type="number" value="0" required>
        <label>备注</label><input id="note" class="input" placeholder="可留空">
        <div style="margin-top:12px"><button class="btn btn-gold" type="submit">提交</button></div>
      </form>
      <div id="m" class="sub" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>最近积分记录</h2>
      <table class="table">
        <thead><tr><th>电话</th><th>积分</th><th>备注</th><th>时间</th></tr></thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { supabase, requireAuth, logout } from './supabase.js'
    await requireAuth(); document.getElementById('logout').onclick = logout

    const f=document.getElementById('f'), m=document.getElementById('m'), tb=document.getElementById('tb')
    f.addEventListener('submit', async (e)=>{ e.preventDefault(); m.textContent=''
      const phone=document.getElementById('ph').value.trim()
      const points=parseInt(document.getElementById('pts').value||'0',10)
      const note=document.getElementById('note').value
      const { data: member, error: e1 } = await supabase.from('members').select('id').eq('phone', phone).maybeSingle()
      if(e1||!member){ m.style.color='#c00'; m.textContent='会员不存在'; return }
      const { error } = await supabase.from('point_transactions').insert([{ member_id: member.id, points, note }])
      if(error){ m.style.color='#c00'; m.textContent=error.message; return }
      m.style.color='#0a7d00'; m.textContent='积分已更新'; f.reset(); load()
    })

    async function load(){
      const { data, error } = await supabase
        .from('point_transactions')
        .select('points,note,created_at,members!inner(phone)')
        .order('created_at',{ascending:false}).limit(30)
      if(error){ tb.innerHTML = `<tr><td colspan="4" style="color:#c00">${error.message}</td></tr>`; return }
      tb.innerHTML = (data||[]).map(r=>`<tr><td>${r.members?.phone||''}</td><td>${r.points}</td><td>${r.note||''}</td><td>${new Date(r.created_at).toLocaleString()}</td></tr>`).join('')||'<tr><td colspan="4">暂无数据</td></tr>'
    } load()
  </script>
</body>
</html>
