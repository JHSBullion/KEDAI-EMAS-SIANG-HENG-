<!DOCTYPE html>

<html lang="zh">
<head>
<meta charset="utf-8"/>
<title data-i18n="admin_points_title">后台 · 积分管理</title>
<link href="style.css" rel="stylesheet"/>
<script src="supabase.js" type="module"></script>
<script src="lang.js" type="module"></script>
</head>
<body>
<div class="navbar">
<div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px;">
<div class="brand"><span class="crest"></span><span data-i18n="points">后台 · 积分管理</span></div>
<div class="nav-right">
<a class="btn" data-i18n="members" href="admin-members.html">会员管理</a>
<a class="btn" data-i18n="points" href="admin-points.html">积分管理</a>
<a class="btn" data-i18n="home" href="index.html">首页</a>
<select class="btn" id="langSwitch">
<option value="zh">中文</option>
<option value="en">English</option>
</select>
<button class="btn btn-ghost" data-i18n="btn_submit" id="logout">登出</button>
</div>
</div>
</div>
<div class="container" style="margin:18px auto;">
<div class="grid-2">
<div class="card">
<h3 data-i18n="points_records">调整积分</h3>
<div class="form-row"><label data-i18n="form_phone">电话</label><input class="input" id="phone" placeholder="请输入手机号"/></div>
<div class="form-row"><label data-i18n="form_delta">积分变动</label><input class="input" id="delta" placeholder="+100 或 -50"/></div>
<div class="form-row"><label data-i18n="form_note">备注</label><input class="input" id="note"/></div>
<button class="btn btn-gold" data-i18n="submit" id="btnSubmit">提交</button>
<div class="alert mt-10" id="msg" style="display:none"></div>
</div>
<div class="card">
<h3 data-i18n="records">积分记录</h3>
<input class="input" data-i18n="search" id="q" placeholder="请输入手机号" style="max-width:320px"/>
<div style="overflow:auto;margin-top:10px">
<table class="table">
<thead>
<tr>
<th data-i18n="table_name">姓名</th>
<th data-i18n="table_phone">电话</th>
<th data-i18n="table_delta">变动</th>
<th data-i18n="table_note">备注</th>
<th data-i18n="table_time">时间</th>
</tr>
</thead>
<tbody id="tbody"><tr><td class="sub" colspan="5" data-i18n="noRecord">暂无记录</td></tr></tbody>
</table>
</div>
</div>
</div>
</div>
<div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>
<script type="module">
    import { supabase } from './supabase.js'
    import { initLang, applyLang } from './lang.js'
    const $ = s=>document.querySelector(s)
    const msg = $('#msg')

    initLang()
    $('#langSwitch').addEventListener('change', e=>applyLang(e.target.value))

    $('#logout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='login.html' })

    function setMsg(t, ok){
      msg.className = 'alert ' + (ok?'alert-success':'alert-error')
      msg.textContent = t; msg.style.display='block'
      if(ok) setTimeout(()=>msg.style.display='none',1500)
    }

    // 提交积分变动
    $('#btnSubmit').addEventListener('click', async ()=>{
      msg.style.display='none'
      const ph = $('#phone').value.trim()
      const d  = Number(($('#delta').value||'').replace(/\s/g,''))
      const nt = $('#note').value.trim()
      if(!ph || !Number.isFinite(d)){ setMsg('请输入有效的手机号与积分变动', false); return }

      const { data: m, error: e1 } = await supabase.from('members').select('id,name,phone,total_points').eq('phone', ph).maybeSingle()
      if(e1){ setMsg(e1.message, false); return }
      if(!m){ setMsg('未找到该会员', false); return }

      const { error: e2 } = await supabase.from('point_transactions').insert([{ member_id: m.id, points: d, note: nt }])
      if(e2){ setMsg(e2.message, false); return }

      const newTotal = (m.total_points||0)+d
      const { error: e3 } = await supabase.from('members').update({ total_points: newTotal }).eq('id', m.id)
      if(e3){ setMsg(e3.message, false); return }

      setMsg('已提交', true)
      $('#delta').value=''; $('#note').value=''; $('#q').value=ph; refresh()
    })

    const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))

    async function refresh(){
      const ph = $('#q').value.trim()
      let req = supabase.from('point_transactions').select(`points,note,created_at,members ( name, phone )`).order('created_at',{ascending:false}).limit(100)
      if(ph) req = req.eq('members.phone', ph)
      const { data, error } = await req
      const tb = $('#tbody')
      if(error){ tb.innerHTML = `<tr><td colspan="5" style="color:#c00">${esc(error.message)}</td></tr>`; return }
      if(!data?.length){ tb.innerHTML = `<tr><td colspan="5" class="sub" data-i18n="noRecord">暂无记录</td></tr>`; return }
      tb.innerHTML = data.map(r=>{
        const pts=Number(r.points)||0, sign=pts>0?'+':'', t=r.created_at?new Date(r.created_at).toLocaleString():''
        return `<tr><td>${esc(r.members?.name)}</td><td>${esc(r.members?.phone)}</td><td>${sign}${pts}</td><td>${esc(r.note)}</td><td>${t}</td></tr>`
      }).join('')
    }

    $('#q').addEventListener('input', refresh)
    refresh()
  </script>
</body>
</html>
