<script type="module">
  import { supabase } from './supabase.js'
  const $ = s => document.querySelector(s)
  const msg = $('#msg')

  $('#logout').addEventListener('click', async () => {
    await supabase.auth.signOut()
    location.href = 'login.html'
  })

  // ---------- 获取当前登录管理员 ----------
  async function getCurrentUserId() {
    try {
      const res = await supabase.auth.getUser()
      return res?.data?.user?.id ?? null
    } catch (e) {
      console.error('getCurrentUserId error:', e)
      return null
    }
  }

  // ---------- 插入积分记录 ----------
  async function addPointTransaction(memberId, points, amount = null, note = '') {
    try {
      const userId = await getCurrentUserId()
      if (!userId) {
        return { data: null, error: { message: '未登入，请先登入管理员账号' } }
      }

      const payload = {
        member_id: memberId,
        points: parseInt(points, 10),
        amount: amount ?? parseInt(points, 10),
        note: note || null,
        created_by: userId
      }

      const { data, error } = await supabase
        .from('point_transactions')
        .insert([payload])

      return { data, error }
    } catch (e) {
      console.error(e)
      return { data: null, error: e }
    }
  }

  // ---------- 提交按钮 ----------
  $('#btnSubmit').addEventListener('click', async () => {
    msg.style.display = 'none'
    const ph = $('#phone').value.trim()
    const dRaw = ($('#delta').value || '').replace(/\s/g, '')
    const d = Number(dRaw)
    const nt = $('#note').value.trim()

    if (!ph || !Number.isFinite(d)) {
      setMsg('请输入有效的手机号与积分变动', false); return
    }

    const { data: m, error: e1 } = await supabase
      .from('members')
      .select('id,name,phone')
      .eq('phone', ph)
      .maybeSingle()

    if (e1) { setMsg(e1.message, false); return }
    if (!m) { setMsg('未找到该会员', false); return }

    const { error: e2 } = await addPointTransaction(m.id, d, d, nt)
    if (e2) { setMsg(e2.message, false); return }

    setMsg('已提交', true)
    $('#delta').value = ''; $('#note').value = ''
    $('#q').value = ph
    refresh()
  })

  function setMsg(t, ok) {
    msg.className = 'alert ' + (ok ? 'alert-success' : 'alert-error')
    msg.textContent = t
    msg.style.display = 'block'
    if (ok) setTimeout(() => msg.style.display = 'none', 1500)
  }

  const esc = s => String(s || '').replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
  }[m]))

  // ---------- 刷新积分记录 ----------
  async function refresh() {
    const ph = $('#q').value.trim()
    let req = supabase.from('point_transactions')
      .select(`
        id,
        points,
        note,
        created_at,
        members:member_id ( name, phone )
      `)
      .order('created_at', { ascending: false })
      .limit(100)

    if (ph) req = req.eq('members.phone', ph)

    const { data, error } = await req
    const tb = $('#tbody')

    if (error) {
      tb.innerHTML = `<tr><td colspan="5" style="color:#c00">${esc(error.message)}</td></tr>`
      return
    }
    if (!data || !data.length) {
      tb.innerHTML = `<tr><td colspan="5" class="sub">${I18N[localStorage.getItem('lang') || 'zh'].no_rows}</td></tr>`
      return
    }

    tb.innerHTML = data.map(r => {
      const pts = Number.isFinite(Number(r.points)) ? Number(r.points) : 0
      const sign = pts > 0 ? '+' : ''
      const t = r.created_at ? new Date(r.created_at).toLocaleString() : ''
      return `<tr>
        <td>${esc(r.members?.name)}</td>
        <td>${esc(r.members?.phone)}</td>
        <td>${sign}${esc(pts)}</td>
        <td>${esc(r.note)}</td>
        <td>${t}</td>
      </tr>`
    }).join('')
  }

  $('#q').addEventListener('input', refresh)
  refresh()
</script>
