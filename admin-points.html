<!doctype html><html lang="zh"><head>
<meta charset="utf-8"><title data-i18n="points">积分管理</title>
<link rel="stylesheet" href="style.css"><script src="lang.js"></script>
<script type="module" src="supabase.js"></script>
</head><body>
<header><h1 data-i18n="points">积分管理</h1><button id="btnLogout" data-i18n="logout">登出</button></header>
<main>
  <div class="card">
    <h2 data-i18n="adjust_points">调整积分</h2>
    <form id="f">
      <label data-i18n="phone">电话</label><input id="ph" required>
      <label data-i18n="points">积分</label><input id="pts" type="number" required value="0">
      <label data-i18n="note">备注</label><input id="note">
      <button type="submit" data-i18n="btn_submit">提交</button>
    </form>
    <div id="m" class="msg"></div>
  </div>
  <div class="card">
    <h2 data-i18n="recent_points">最近积分记录</h2>
    <table><thead><tr><th data-i18n="phone">电话</th><th data-i18n="points">积分</th><th data-i18n="note">备注</th><th data-i18n="created_at">时间</th></tr></thead><tbody id="tb"></tbody></table>
  </div>
</main>
<script type="module">
  import { supabase, requireAuth, logout } from './supabase.js'; await requireAuth(); document.getElementById('btnLogout').onclick = logout
  const f=document.getElementById('f'), m=document.getElementById('m'), tb=document.getElementById('tb')
  f.addEventListener('submit', async (e)=>{ e.preventDefault(); m.textContent=''
    const phone=document.getElementById('ph').value.trim(); const points=parseInt(document.getElementById('pts').value||'0'); const note=document.getElementById('note').value
    const { data: member, error: e1 } = await supabase.from('members').select('id').eq('phone', phone).single()
    if(e1||!member){ m.className='msg err'; m.textContent='会员不存在'; return }
    const { error } = await supabase.from('point_transactions').insert([{ member_id: member.id, points, note }])
    if(error){ m.className='msg err'; m.textContent=error.message; return }
    m.className='msg ok'; m.textContent='积分已更新'; f.reset(); load()
  })
  async function load(){
    const { data, error } = await supabase.from('point_transactions').select('points,note,created_at,members!inner(phone)').order('created_at',{ascending:false}).limit(30)
    if(error){ tb.innerHTML = `<tr><td colspan="4" style="color:#c00">${error.message}</td></tr>`; return }
    tb.innerHTML = (data||[]).map(r=>`<tr><td>${r.members?.phone||''}</td><td>${r.points}</td><td>${r.note||''}</td><td>${new Date(r.created_at).toLocaleString()}</td></tr>`).join('')||'<tr><td colspan="4">No data</td></tr>'
  } load()
</script>
</body></html>