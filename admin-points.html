<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title data-i18n="admin_points_title">后台 · 积分管理</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="supabase.js"></script>
</head>
<body> 
  <div class="navbar">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px;">
      <div class="brand">
        <span class="crest"></span>
        <span data-i18n="admin_nav_points">后台 · 积分管理</span>
      </div>
      <div class="nav-right">
        <a class="btn" href="admin-members.html" data-i18n="nav_members">会员管理</a>
        <a class="btn" href="admin-points.html" data-i18n="nav_points">积分管理</a>
        <a class="btn" href="index.html" data-i18n="nav_home">首页</a>
        <select id="lang" class="lang-select">
          <option value="zh">中</option>
          <option value="en">EN</option>
          <option value="bm">BM</option>
        </select>
        <button id="logout" class="btn btn-ghost" data-i18n="nav_logout">登出</button>
      </div>
    </div>
  </div>

  <div class="container" style="margin:18px auto;">
    <div class="grid-2">
      <!-- 左：调整积分 -->
      <div class="card">
        <h3 data-i18n="adjust_points_title">调整积分</h3>

        <div class="form-row">
          <label data-i18n="label_phone">电话</label>
          <input id="phone" class="input" data-i18n-ph="ph_phone" placeholder="请输入手机号">
        </div>
        <div class="form-row">
          <label data-i18n="label_delta">积分变动（正数加分，负数扣分）</label>
          <input id="delta" class="input" placeholder="+100 或 -50">
        </div>
        <div class="form-row">
          <label data-i18n="label_note">备注</label>
          <input id="note" class="input">
        </div>
        <button id="btnSubmit" class="btn btn-gold" data-i18n="btn_submit">提交</button>
        <div id="msg" class="alert mt-10" style="display:none"></div>
      </div>

      <!-- 右：记录 -->
      <div class="card">
        <h3 data-i18n="points_list_title">积分记录</h3>
        <input id="q" class="input" style="max-width:320px" data-i18n-ph="ph_phone" placeholder="请输入手机号">
        <div style="overflow:auto;margin-top:10px">
          <table class="table">
            <thead>
              <tr>
                <th data-i18n="th_name">姓名</th>
                <th data-i18n="th_phone">电话</th>
                <th data-i18n="th_change">变动</th>
                <th data-i18n="th_note">备注</th>
                <th data-i18n="th_time">时间</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="5" class="sub" data-i18n="no_rows">暂无记录</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>

  <!-- 引入语言文件 -->
  <script src="lang.js"></script>

  <script type="module">
    import { supabase } from './supabase.js'
    const $ = s=>document.querySelector(s)
    const msg = $('#msg')

    // ---------- 登出 ----------
    $('#logout').addEventListener('click', async ()=>{ 
      await supabase.auth.signOut(); 
      location.href='login.html' 
    })

    // ---------- 提交积分变动 ----------
    $('#btnSubmit').addEventListener('click', async ()=>{
      msg.style.display='none'
      const ph = $('#phone').value.trim()
      const dRaw = ($('#delta').value||'').replace(/\s/g,'')
      const d  = Number(dRaw)
      const nt = $('#note').value.trim()
      if(!ph || !Number.isFinite(d)){
        setMsg(I18N[currentLang].error_invalid_input, false); return
      }

      // 查会员
      const { data: m, error: e1 } = await supabase
        .from('members')
        .select('id,name,phone,total_points')
        .eq('phone', ph)
        .maybeSingle();

      if (e1) { setMsg(e1.message, false); return }
      if (!m) { setMsg(I18N[currentLang].error_member_not_found, false); return }

      // 插入积分记录
      const { error: e2 } = await supabase
        .from('point_transactions')
        .insert([{
          member_id: m.id,
          points: d,
          amount: d,
          note: nt
        }])

      if(e2){ setMsg(e2.message, false); return }

      // 更新会员总积分
      const newTotal = (m.total_points || 0) + d
      const { error: e3 } = await supabase
        .from('members')
        .update({ total_points: newTotal })
        .eq('id', m.id)

      if(e3){ setMsg(e3.message, false); return }

      setMsg(I18N[currentLang].msg_success, true)
      $('#delta').value=''; $('#note').value=''
      $('#q').value = ph
      refresh()
    })

    function setMsg(t, ok){
      msg.className = 'alert ' + (ok?'alert-success':'alert-error')
      msg.textContent = t; msg.style.display='block'
      if(ok) setTimeout(()=>msg.style.display='none',1500)
    }

    const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))

    // ---------- 刷新积分记录 ----------
    async function refresh(){
      const ph = $('#q').value.trim()
      let req = supabase.from('point_transactions')
        .select(`
          points,
          note,
          created_at,
          members ( name, phone )
        `)
        .order('created_at',{ascending:false})
        .limit(100)

      if(ph) req = req.eq('members.phone', ph)

      const { data, error } = await req
      const tb = $('#tbody')

      if(error){ 
        tb.innerHTML = `<tr><td colspan="5" style="color:#c00">${esc(error.message)}</td></tr>`; 
        return 
      }
      if(!data || !data.length){ 
        tb.innerHTML = `<tr><td colspan="5" class="sub" data-i18n="no_rows">${I18N[currentLang].no_rows}</td></tr>`; 
        return 
      }

      tb.innerHTML = data.map(r=>{
        const pts = Number(r.points)||0
        const sign = pts>0? '+' : ''
        const t = r.created_at ? new Date(r.created_at).toLocaleString() : ''
        return `<tr>
          <td>${esc(r.members?.name)}</td>
          <td>${esc(r.members?.phone)}</td>
          <td>${sign}${esc(pts)}</td>
          <td>${esc(r.note)}</td>
          <td>${t}</td>
        </tr>`
      }).join('')
    }

    $('#q').addEventListener('input', refresh)
    refresh()

    // ---------- 多语言切换 ----------
    const langSel = document.getElementById('lang')
    let currentLang = localStorage.getItem('lang') || 'zh'
    langSel.value = currentLang
    applyLang(currentLang)

    langSel.addEventListener('change', ()=>{
      currentLang = langSel.value
      localStorage.setItem('lang', currentLang)
      applyLang(currentLang)
    })

    function applyLang(lang){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n')
        if(I18N[lang] && I18N[lang][key]){
          el.textContent = I18N[lang][key]
        }
      })
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
        const key = el.getAttribute('data-i18n-ph')
        if(I18N[lang] && I18N[lang][key]){
          el.placeholder = I18N[lang][key]
        }
      })
    }
  </script>
</body>
</html>
