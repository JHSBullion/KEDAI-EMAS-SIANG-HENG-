
<!doctype html><html lang="zh">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · Points</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="lang.js"></script>
  <script src="app.js"></script>
  <script src="supabase.js"></script>
</head>
<body>
  <div id="nav"></div>
  <div class="container">
    <div class="grid two">
      <div class="card">
        <div class="title" data-i18n="points">积分管理</div>
        <label data-i18n="phone">电话</label>
        <input id="pphone" class="input mono" data-ph="phone">
        <label data-i18n="changePoints">积分变动（正数加分，负数扣分）</label>
        <input id="pdelta" class="input mono" placeholder="+100 or -50">
        <label data-i18n="note">备注</label>
        <input id="pnote" class="input">
        <div class="actions">
          <button class="btn gold" onclick="addPointTx()" data-i18n="submit">提交</button>
          <div id="pmsg" class="note hidden"></div>
        </div>
      </div>
      <div class="card">
        <div class="title" data-i18n="history">积分记录</div>
        <div class="search">
          <input id="pq" class="input mono" style="max-width:300px" data-ph="phone" placeholder="Enter phone">
          <button class="btn" onclick="loadTx()" data-i18n="history">积分记录</button>
        </div>
        <table class="table" id="pt">
          <thead><tr>
            <th data-i18n="name">姓名</th><th data-i18n="phone">电话</th><th data-i18n="delta">变动</th><th data-i18n="note">备注</th><th data-i18n="time">时间</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>

<script>
document.getElementById('nav').innerHTML = adminbar('points');
bindLangSelect();
guard();

async function getMemberByPhone(phone){
  const { data, error } = await sb.from('members').select('*').eq('phone', phone).maybeSingle();
  if(error) throw error;
  return data;
}
async function addPointTx(){
  const phone = document.getElementById('pphone').value.trim();
  const deltaStr = document.getElementById('pdelta').value.trim();
  const note = document.getElementById('pnote').value.trim();
  const msg = document.getElementById('pmsg'); msg.classList.add('hidden'); msg.textContent='';
  if(!phone || !deltaStr){ msg.textContent='Phone/Delta required'; msg.classList.remove('hidden'); return; }
  const delta = parseInt(deltaStr,10);
  if(isNaN(delta)){ msg.textContent='Delta must be integer'; msg.classList.remove('hidden'); return; }
  try{
    let m = await getMemberByPhone(phone);
    if(!m){ // auto create member if not exists
      const ins = await sb.from('members').insert({ name: phone, phone }).select('*').maybeSingle();
      if(ins.error) throw ins.error;
      m = ins.data;
    }
    const { error } = await sb.from('point_transactions').insert({ member_id: m.id, delta, note });
    if(error) throw error;
    document.getElementById('pdelta').value=''; document.getElementById('pnote').value='';
    loadTx();
  }catch(e){ msg.textContent = e.message; msg.classList.remove('hidden'); }
}
async function loadTx(){
  const phone = document.getElementById('pq').value.trim();
  let query = sb.from('point_transactions').select('*, members(name,phone)').order('created_at',{ascending:false}).limit(200);
  if(phone){
    // join-like filter: first get member id by phone
    const m = await getMemberByPhone(phone);
    if(!m){ document.querySelector('#pt tbody').innerHTML='<tr><td colspan="5">No records</td></tr>'; return; }
    query = query.eq('member_id', m.id);
  }
  const { data, error } = await query;
  const tb = document.querySelector('#pt tbody'); tb.innerHTML='';
  if(error){ tb.innerHTML = `<tr><td colspan="5" class="bad">${error.message}</td></tr>`; return; }
  (data||[]).forEach(r=>{
    let name='', phone='';
    if(r.members){ name=r.members.name||''; phone=r.members.phone||''; }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td class="mono">${phone}</td><td class="${r.delta>=0?'good':'bad'}">${r.delta>=0?'+':''}${r.delta}</td><td>${r.note||''}</td><td>${r.created_at||''}</td>`;
    tb.appendChild(tr);
  });
}
loadTx();
</script>
</body></html>
