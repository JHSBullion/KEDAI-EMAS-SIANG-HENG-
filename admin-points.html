<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin · Adjust Points · KEDAI EMAS SIANG HENG</title>
<link rel="icon" href="data:,">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f172a;color:#e5e7eb;margin:0;padding:24px}
  .card{max-width:820px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:14px;padding:20px}
  h1{margin:0 0 10px;font-size:22px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
  input,button{height:40px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb;padding:0 12px;font-size:14px}
  input{flex:1;min-width:220px}
  button{cursor:pointer;background:#2563eb;border-color:#3b82f6}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}
  .msg{min-height:24px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const ADMIN_PASS="123456";
const SB = supabase.createClient("https://mnzwqqxybhjqrfzydwk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uendxcXh5YmhqcXJmcnp5ZHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NzgzMzIsImV4cCI6MjA3MjA1NDMzMn0.Yo27vsFqgVM9wWKRgI-ErV2Fl6kjsYcQQPqbe8nGZOQ");
const $ = s => document.querySelector(s);
const tip=(t,ok=true)=>{$('#msg').innerHTML=`<span style="color:${ok?'#34d399':'#f87171'}">${t}</span>`;setTimeout(()=>$('#msg').innerHTML='',2500);};

function gate(){ const p = prompt("Admin Password"); if(p!==ADMIN_PASS){ alert("Wrong password"); location.reload(); } }
document.addEventListener('DOMContentLoaded', gate);

let current = null;
async function findMember(){
  const phone = $('#phone').value.trim();
  if(!phone){ tip("Phone required", false); return; }
  const { data, error } = await SB.from('member_points').select('member_id,name,phone,points').eq('phone', phone).maybeSingle();
  if(error || !data){ tip("Member not found", false); return; }
  current = { id: data.member_id, name: data.name, phone: data.phone, points: data.points??0 };
  $('#mName').textContent = current.name;
  $('#mPhone').textContent = current.phone;
  $('#mPoints').textContent= current.points;
  $('#memberInfo').style.display='';
  loadLogs();
}

async function submitDelta(){
  if(!current){ tip("Find a member first", false); return; }
  const delta = parseInt($('#delta').value, 10);
  const reason = $('#reason').value.trim();
  if(!Number.isInteger(delta) || delta===0){ tip("Enter a non-zero integer", false); return; }
  const { error } = await SB.from('point_transactions').insert({ member_id: current.id, delta, reason: reason||null });
  if(error){ tip(error.message, false); return; }
  tip("Updated!");
  $('#delta').value=''; $('#reason').value='';
  await refreshPoints(); loadLogs();
}

async function refreshPoints(){
  const { data } = await SB.from('member_points').select('points').eq('member_id', current.id).maybeSingle();
  if(data){ current.points = data.points??0; $('#mPoints').textContent = current.points; }
}
async function loadLogs(){
  const { data } = await SB.from('point_transactions').select('delta,reason,created_at').eq('member_id', current.id).order('created_at', {ascending:false}).limit(20);
  $('#logs').innerHTML = (data||[]).map(r=>`<tr><td>${new Date(r.created_at).toLocaleString()}</td><td>${r.delta>0?('+'+r.delta):r.delta}</td><td>${r.reason||''}</td></tr>`).join('') || `<tr><td colspan="3" style="color:#9ca3af">No records</td></tr>`;
}
function quick(n){ $('#delta').value=n; submitDelta(); }
</script>
</head>
<body>
<div class="card">
  <h1>Adjust Points · KEDAI EMAS SIANG HENG</h1>

  <div class="row">
    <input id="phone" placeholder="Phone (unique)" />
    <button onclick="findMember()">Find</button>
    <button onclick="(()=>{document.getElementById('phone').value='';document.getElementById('memberInfo').style.display='none';current=null;})()">Clear</button>
  </div>
  <div id="msg" class="msg"></div>

  <div id="memberInfo" style="display:none">
    <div><b>Name:</b> <span id="mName"></span></div>
    <div><b>Phone:</b> <span id="mPhone"></span></div>
    <div><b>Points:</b> <span id="mPoints">0</span></div>

    <div class="row" style="margin-top:10px">
      <input id="delta" placeholder="Enter + or - integer" />
      <input id="reason" placeholder="Reason (optional)" />
      <button onclick="submitDelta()">Submit</button>
    </div>

    <div class="row">
      <button onclick="quick(10)">+10</button>
      <button onclick="quick(-10)">-10</button>
      <button onclick="quick(50)">+50</button>
      <button onclick="quick(-50)">-50</button>
    </div>

    <h3 style="margin-top:18px">Recent Transactions</h3>
    <table>
      <thead><tr><th>Time</th><th>Delta</th><th>Reason</th></tr></thead>
      <tbody id="logs"></tbody>
    </table>
  </div>
</div>
</body>
</html>
