<script type="module">
  import { supabase } from './supabase.js'
  const $ = s => document.querySelector(s)
  const msg = $('#msg')

  $('#logout').addEventListener('click', async () => {
    await supabase.auth.signOut()
    location.href = 'login.html'
  })

  // ---------- Helper: 获取当前登录用户 id ----------
  async function getCurrentUserId() {
    try {
      if (supabase.auth && supabase.auth.getUser) {
        const res = await supabase.auth.getUser()
        return res?.data?.user?.id ?? null
      }
      if (supabase.auth && typeof supabase.auth.user === 'function') {
        const u = supabase.auth.user()
        return u?.id ?? null
      }
      if (supabase.auth && typeof supabase.auth.session === 'function') {
        const s = supabase.auth.session()
        return s?.user?.id ?? null
      }
      return null
    } catch (e) {
      console.warn('getCurrentUserId error:', e)
      return null
    }
  }

  // ---------- 插入函数 ----------
  async function addPointTransaction(memberId, points, amount = null, note = '') {
    try {
      const member_id = (memberId === null || memberId === undefined) ? '' : String(memberId).trim()
      const pts = Number.isNaN(parseInt(points, 10)) ? 0 : parseInt(points, 10)
      const amt = amount === null ? pts : (Number.isNaN(parseInt(amount, 10)) ? 0 : parseInt(amount, 10))

      if (!member_id) {
        return { data: null, error: { message: 'invalid member id' } }
      }

      const userId = await getCurrentUserId()
      if (!userId) {
        return { data: null, error: { message: '当前未登入，请先登入管理员账号' } }
      }

      const payload = {
        member_id,
        points: pts,
        amount: amt,
        note: note || null,
        created_by: userId
      }

      const { data, error } = await supabase
        .from('point_transactions')
        .insert([payload])

      if (error) {
        console.error('Supabase insert error:', error, 'payload:', payload)
        return { data: null, error }
      }

      return { data, error: null }
    } catch (e) {
      console.error('unexpected error in addPointTransaction:', e)
      return { data: null, error: e }
    }
  }

  // ---------- 提交按钮 ----------
  $('#btnSubmit').addEventListener('click', async () => {
    msg.style.display = 'none'
    const ph = $('#phone').value.trim()
    const dRaw = ($('#delta').value || '').replace(/\s/g, '')
    const d = Number(dRaw)
    const nt = $('#note').value.trim()

    if (!ph || !Number.isFinite(d)) {
      setMsg('请输入有效的手机号与积分变动', false); return
    }

    const { data: m, error: e1 } = await supabase
      .from('members')
      .select('id,name,phone')
      .eq('phone', ph)
      .maybeSingle()

    if (e1) {
      console.error('查会员出错：', e1)
      setMsg(e1.message || '查会员出错', false)
      return
    }
    if (!m) { setMsg('未找到该会员', false); return }

    const { error: e2 } = await addPointTransaction(m.id, d, d, nt)
    if (e2) { setMsg(e2.message || JSON.stringify(e2), false); return }

    setMsg('已提交', true)
    $('#delta').value = ''; $('#note').value = ''
    $('#q').value = ph
    refresh()
  })

  function setMsg(t, ok) {
    msg.className = 'alert ' + (ok ? 'alert-success' : 'alert-error')
    msg.textContent = t; msg.style.display = 'block'
    if (ok) setTimeout(() => msg.style.display = 'none', 1500)
  }

  const esc = s => String(s || '').replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
  }[m]))

  // ---------- 刷新积分记录 ----------
  async function refresh() {
    const ph = $('#q').value.trim()
    let req = supabase.from('point_transactions')
      .select(`
        id,
        points,
        note,
        created_at,
        members:member_id ( name, phone )
      `)
      .order('created_at', { ascending: false })
      .limit(100)

    if (ph) {
      req = req.eq('members.phone', ph)
    }

    const { data, error } = await req
    const tb = $('#tbody')
    if (error) {
      tb.innerHTML = `<tr><td colspan="5" style="color:#c00">${esc(error.message)}</td></tr>`
      console.error(error)
      return
    }
    if (!data || !data.length) {
      tb.innerHTML = `<tr><td colspan="5" class="sub">${I18N[localStorage.getItem('lang') || 'zh'].no_rows}</td></tr>`
      return
    }

    tb.innerHTML = data.map(r => {
      const pts = Number.isFinite(Number(r.points)) ? Number(r.points) : 0
      const sign = pts > 0 ? '+' : ''
      const t = r.created_at ? new Date(r.created_at).toLocaleString() : ''
      return `<tr>
        <td>${esc(r.members?.name)}</td>
        <td>${esc(r.members?.phone)}</td>
        <td>${sign}${esc(pts)}</td>
        <td>${esc(r.note)}</td>
        <td>${t}</td>
      </tr>`
    }).join('')
  }

  $('#q').addEventListener('input', refresh)
  refresh()
</script>
