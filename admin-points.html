<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Admin · Points</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="supabase.js"></script>
</head>
<body>
  <div class="navbar">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;height:60px;">
      <div class="brand"><span class="crest"></span><span data-i18n="admin_nav_points">后台 · 积分管理</span></div>
      <div class="nav-right">
        <a class="btn" href="admin-members.html" data-i18n="nav_members">会员管理</a>
        <a class="btn" href="admin-points.html"  data-i18n="nav_points">积分管理</a>
        <a class="btn" href="index.html"          data-i18n="nav_home">首页</a>
        <select class="lang-select">
          <option value="zh">中</option><option value="en">EN</option><option value="bm">BM</option>
        </select>
        <button id="logout" class="btn btn-ghost" data-i18n="nav_logout">登出</button>
      </div>
    </div>
  </div>

  <div class="container" style="margin:18px auto;">
    <div class="grid-2">
      <!-- 左：调整积分 -->
      <div class="card">
        <h3 data-i18n="adjust_points_title">调整积分</h3>

        <div class="form-row">
          <label data-i18n="label_phone">电话</label>
          <input id="phone" class="input" data-i18n-ph="ph_phone" placeholder="请输入手机号">
        </div>
        <div class="form-row">
          <label data-i18n="label_delta">积分变动（正数加分，负数扣分）</label>
          <input id="delta" class="input" placeholder="+100 或 -50">
        </div>
        <div class="form-row">
          <label data-i18n="label_note">备注</label>
          <input id="note" class="input">
        </div>
        <button id="btnSubmit" class="btn btn-gold" data-i18n="btn_add_points">提交</button>
        <div id="msg" class="alert mt-10" style="display:none"></div>
      </div>

      <!-- 右：记录 -->
      <div class="card">
        <h3 data-i18n="points_list_title">积分记录</h3>
        <input id="q" class="input" style="max-width:320px" data-i18n-ph="ph_phone" placeholder="请输入手机号">
        <div style="overflow:auto;margin-top:10px">
          <table class="table">
            <thead>
              <tr>
                <th data-i18n="th_name">姓名</th>
                <th data-i18n="th_phone">电话</th>
                <th data-i18n="th_change">变动</th>
                <th data-i18n="th_note">备注</th>
                <th data-i18n="th_time">时间</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="5" class="sub" data-i18n="no_rows">暂无记录</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">© 2025 KEDAI EMAS SIANG HENG · All rights reserved.</div>

  <script src="lang.js"></script>
  <script type="module">
    import { supabase } from './supabase.js'
    const $ = s=>document.querySelector(s)
    const msg = $('#msg')

    $('#logout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='login.html' })

    // ============== 封装插入函数：确保传入 created_by（当前登录用户 id） ==============
    /**
     * addPointTransaction - 插入一笔积分记录到 point_transactions
     * 会自动尝试获取当前登录用户 id 并放入 created_by（若未登录会返回错误）
     * @param {string|number} memberId - 会员 ID（UUID 字符串或数字 id）
     * @param {number|string} points
     * @param {number|string} amount - 确保传入（默认 0）
     * @param {string} note
     * @returns {object} { data, error }
     */
    async function addPointTransaction(memberId, points, amount = 0, note = '') {
      try {
        // 1) 取得当前登录用户 id（兼容 supabase v2 & v1）
        let userId = null;
        try {
          if (supabase.auth.getUser) {
            const res = await supabase.auth.getUser();
            userId = res?.data?.user?.id ?? null;
          } else if (supabase.auth.user) {
            const u = supabase.auth.user();
            userId = u?.id ?? null;
          } else if (supabase.auth.session) {
            const s = supabase.auth.session();
            userId = s?.user?.id ?? null;
          }
        } catch (e) {
          console.warn('获取用户 id 失败：', e);
          userId = null;
        }

        if (!userId) {
          const err = { message: '当前未登入，请先登入管理员账号再提交' };
          console.error('addPointTransaction: no logged in user', { memberId, points, amount, note });
          return { data: null, error: err };
        }

        // 2) member_id 保留原样（不要 parseInt），points & amount 做整数化
        let member_id = (memberId === null || memberId === undefined) ? '' : String(memberId).trim();
        const pts = Number.isNaN(parseInt(points, 10)) ? 0 : parseInt(points, 10);
        const amt = Number.isNaN(parseInt(amount, 10)) ? 0 : parseInt(amount, 10);

        // 基础校验：允许 UUID 或纯数字 id
        const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/;
        const digitsRegex = /^\d+$/;
        if (!member_id || !(uuidRegex.test(member_id) || digitsRegex.test(member_id))) {
          const err = { message: '无效的会员 ID（需为 UUID 或数字 id）' };
          console.error('addPointTransaction invalid member id', { memberId, points, amount, note });
          return { data: null, error: err };
        }

        const payload = {
          member_id,
          points: pts,
          amount: amt,
          note: note || null,
          created_by: userId
        };

        const { data, error } = await supabase
          .from('point_transactions')
          .insert([payload]);

        if (error) {
          console.error('Supabase insert error:', error, 'payload:', payload);
          return { data: null, error };
        }

        console.log('inserted point_transaction:', data);
        return { data, error: null };
      } catch (e) {
        console.error('unexpected error in addPointTransaction:', e);
        return { data: null, error: e };
      }
    }

    // ============== 绑定提交按钮，使用上面的函数 ==============
    $('#btnSubmit').addEventListener('click', async ()=>{
      msg.style.display='none'
      const ph = $('#phone').value.trim()
      const d  = Number(($('#delta').value||'').replace(/\s/g,'')) // 支持 +100 / -50
      const nt = $('#note').value.trim()
      if(!ph || !Number.isFinite(d)){
        setMsg('请输入有效的手机号与积分变动', false); return
      }
      // 取得会员（members.id 很可能是 UUID 字符串）
      const { data: m, error: e1 } = await supabase.from('members').select('id,name,phone').eq('phone', ph).maybeSingle()
      if(e1 || !m){ setMsg(e1?.message || '未找到该会员', false); return }

      // 用 addPointTransaction，确保 created_by 会被传入（此处 amount 默认 0）
      const { data: insData, error: e2 } = await addPointTransaction(m.id, d, 0, nt)
      if(e2){
        setMsg(e2.message || JSON.stringify(e2), false);
        // 若是未登录错误，提醒并跳到登录页（可选）
        if (e2.message && e2.message.includes('未登入')) {
          // 可自动跳转登录页，若不想自动跳则注释下一行
          // location.href = 'login.html';
        }
        return
      }

      setMsg('已提交', true)
      $('#delta').value=''; $('#note').value=''
      $('#q').value = ph
      refresh()
    })

    function setMsg(t, ok){
      msg.className = 'alert ' + (ok?'alert-success':'alert-error')
      msg.textContent = t; msg.style.display='block'
      if(ok) setTimeout(()=>msg.style.display='none',1500)
    }
    const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))
    async function refresh(){
      const ph = $('#q').value.trim()
      let req = supabase.from('point_transactions')
        .select('points,note,created_at,members!inner(name,phone)')
        .order('created_at',{ascending:false}).limit(100)
      if(ph) req = req.eq('members.phone', ph)
      const { data, error } = await req
      const tb = $('#tbody')
      if(error){ tb.innerHTML = `<tr><td colspan="5" style="color:#c00">${esc(error.message)}</td></tr>`; console.error(error); return }
      if(!data || !data.length){ tb.innerHTML = `<tr><td colspan="5" class="sub">${I18N[localStorage.getItem('lang')||'zh'].no_rows}</td></tr>`; return }
      tb.innerHTML = data.map(r=>{
        const pts = Number.isFinite(Number(r.points)) ? Number(r.points) : 0
        const sign = pts>0? '+' : ''
        const t = r.created_at ? new Date(r.created_at).toLocaleString() : ''
        return `<tr>
          <td>${esc(r.members?.name)}</td>
          <td>${esc(r.members?.phone)}</td>
          <td>${sign}${esc(pts)}</td>
          <td>${esc(r.note)}</td>
          <td>${t}</td>
        </tr>`
      }).join('')
    }
    $('#q').addEventListener('input', refresh)
    refresh()
  </script>
</body>
</html>
